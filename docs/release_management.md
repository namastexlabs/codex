# Release Management for Namastex Labs Codex Fork\n\nThis document outlines the process for publishing releases of our fork of the Codex project (https://github.com/namastexlabs/codex) to npm under the `@namastexlabs/codex` scope. The process mirrors the upstream OpenAI workflow as closely as possible, with adaptations for our fork, including the added `append_user_instructions_file` configuration option and the namespace change.\n\n## Review of NPM Configuration Updates\n\n### Key Changes\n- **Package Scope**: The `name` in `codex-cli/package.json` has been updated from `@openai/codex` to `@namastexlabs/codex`. This ensures publications go to our scoped namespace on npm.\n- **Repository URL**: Updated in `package.json` to point to `https://github.com/namastexlabs/codex.git`.\n- **Build Scripts**: \n - `codex-cli/scripts/build_npm_package.py`: This script stages the NPM package by copying JavaScript binaries (`bin/codex.js`, `rg`), updating `package.json` with the version, and installing native binaries from a GitHub Actions workflow. For our fork, update `GITHUB_REPO = \"openai/codex\"` to `GITHUB_REPO = \"namastexlabs/codex\"` to resolve workflows and releases from our repository.\n - `codex-cli/scripts/install_native_deps.py`: Downloads native binaries (e.g., `codex`, `rg`) from the specified workflow artifacts and places them in `vendor/`.\n- **Other Files**: The `append_user_instructions_file` override is implemented in `codex-rs/core/src/config.rs` and related tests. This feature is compiled into the Rust binaries during the CI build, so no additional NPM-specific changes are needed.\n- **NPM Dist**: `codex-cli/npm-dist/codex/package.json` also reflects the scope change.\n\n### Sufficiency Confirmation\nThe changes are sufficient for publishing under `@namastexlabs/codex` without breaking the upstream process:\n- The scope update in `package.json` directs `npm publish` to our namespace.\n- The build scripts remain functional once `GITHUB_REPO` is updated; they stage the package identically to upstream.\n- The Rust changes (e.g., `append_user_instructions_file`) are included in the native binaries fetched from our CI, ensuring the fork's features are packaged.\n- No upstream dependencies are altered; we mirror the workflow by running equivalent CI in our fork.\n\nIf `GITHUB_REPO` is not updated, the script will fail to resolve our releases/workflowsâ€”update it before proceeding.\n\n## Prerequisites\n\nBefore starting, ensure the following:\n\n- **Repository Setup**:\n - Clone the fork: `git clone https://github.com/namastexlabs/codex`\n - Update `codex-cli/scripts/build_npm_package.py`: Change `GITHUB_REPO = \"openai/codex\"` to `GITHUB_REPO = \"namastexlabs/codex\"`.\n - Mirror upstream CI: Ensure `.github/workflows/rust-release.yml` exists in the fork (copy from upstream if needed) to build Rust binaries and artifacts.\n\n- **Tools and Environment**:\n - Node.js >=16 (check with `node --version`).\n - npm installed and logged in: `npm login` (use an account with publish access to the `@namastexlabs` scope).\n - GitHub CLI (`gh`) installed and authenticated: `gh auth login` (select GitHub.com, HTTPS/SSH, and authorize for `namastexlabs/codex` repo).\n - Python 3 (for build scripts).\n - Git configured for pushing tags.\n\n- **CI Preparation**:\n - The fork's GitHub repo must have Actions enabled.\n - Test the `rust-release` workflow manually if needed.\n\n## Cutting a Rust Release (Mirroring Upstream)\n\nReleases start with tagging and running CI to build binaries, similar to upstream.\n\n1. Navigate to the repo root: `cd codex`\n2. Run the release script (adapt from upstream if needed; assumes `codex-rs/scripts/create_github_release` is available and updated for the fork):\n `bash\n   ./codex-rs/scripts/create_github_release --publish-release\n   `\n - This bumps the version (e.g., to `0.1.0`), creates a `rust-v0.1.0` branch/tag, pushes to GitHub, and triggers the `rust-release` workflow.\n - For alpha releases: `--publish-alpha` (tags like `rust-v0.1.0-alpha.1`).\n - Use `--dry-run` to preview the version without publishing.\n3. Monitor the workflow: Go to https://github.com/namastexlabs/codex/actions/workflows/rust-release.yml and wait for completion (builds Rust binaries and uploads artifacts).\n4. Note the workflow run URL (e.g., from the Actions page) for staging.\n\nThis step mirrors upstream's GitHub Release creation.\n\n## Staging the NPM Package\n\nUse `build_npm_package.py` to stage the package contents, including native binaries from the CI workflow.\n\n1. From the repo root, run:\n `bash\n   cd codex-cli\n   python scripts/build_npm_package.py --release-version 0.1.0 --staging-dir ../dist/codex-v0.1.0\n   `\n - `--release-version`: Matches the Rust tag (e.g., `0.1.0`).\n - The script auto-resolves the workflow URL via `gh` (using the updated `GITHUB_REPO`).\n - If manual: Add `--workflow-url https://github.com/namastexlabs/codex/actions/runs/123456789`.\n - Output: Stages in `../dist/codex-v0.1.0/` with `bin/`, `vendor/` (natives), `package.json` (version updated), and `README.md`.\n2. The script prints verification commands and the staging path.\n\nThis fetches binaries via `install_native_deps.py`, ensuring the fork's features (e.g., `append_user_instructions_file`) are included.\n\n## Verification\n\nVerify the staged package before publishing.\n\n1. `cd ../dist/codex-v0.1.0`\n2. Check version: `node bin/codex.js --version` (should output `0.1.0`).\n3. Check help: `node bin/codex.js --help` (confirms functionality).\n4. Dry-run pack: `npm pack --dry-run` (verifies `package.json` and files).\n5. Inspect files: Ensure `vendor/` has platform-specific binaries (e.g., `codex-linux-x86_64`, `rg-linux-x86_64`).\n6. Test a feature: e.g., `node bin/codex.js config set append_user_instructions_file /path/to/file` (verifies fork addition).\n\nIf issues arise (e.g., binaries missing), re-run the workflow or provide `--workflow-url`.\n\n## Publishing to NPM\n\nPublish the staged package to npm.\n\n1. From the staging directory: `cd ../dist/codex-v0.1.0`\n2. Publish:\n `bash\n   npm publish --access public\n   `\n - `--access public`: Required for scoped packages.\n - Confirms with `https://www.npmjs.com/package/@namastexlabs/codex`.\n3. Verify on npm: Check the package page for the new version.\n\nThis mirrors upstream's NPM publication but under our scope.\n\n## Tagging and Post-Release\n\n- **Git Tagging**: Already handled by `create_github_release` (e.g., `rust-v0.1.0`).\n- **GitHub Release**: The workflow creates a release with binaries; edit notes if needed.\n- **Changelog**: Update `CHANGELOG.md` with release notes (e.g., add fork features like `append_user_instructions_file`).\n- **Cleanup**: Remove staging dir after successful publish.\n- **Homebrew (Optional)**: Upstream uses Homebrew automation; for our fork, submit a formula to a tap if desired (not mirrored here).\n\n## Troubleshooting\n\n- **Workflow Resolution Fails**: Ensure `GITHUB_REPO` is updated and the tag/workflow exists.\n- **NPM Auth Errors**: Verify `npm whoami` and scope access.\n- **Binary Download Fails**: Check CI artifacts; re-run workflow if needed.\n- **Version Conflicts**: Use semantic versioning; avoid overwriting published versions.\n\nDouble-checked paths/commands against repo: `codex-cli/scripts/build_npm_package.py`, `codex-cli/package.json`, root `dist/` for staging.\n
